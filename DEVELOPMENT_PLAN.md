# Development Plan (iwb_canvas_engine)

Правило: после выполнения любого пункта отмечать соответствующий чекбокс в этом файле.

## Этап 0 — Документация и контекст

- [x] Зафиксировать требования и решения (см. `TZ.md`, Appendix A).
- [x] Описать архитектуру и контекст (`ARCHITECTURE.md`, `AGENTS.md`).
- [x] Сверить структуру папок пакета с deliverables (`lib/core`, `lib/render`, `lib/input`, `lib/serialization`).

## Этап 1 — Core модель и математика

- [x] Описать базовую модель `Scene`, `Layer`, `Node` и типы узлов.
- [x] Реализовать геометрию: AABB, поворот вокруг точки, отражение относительно оси.
- [x] Реализовать пересчёт координат с учётом камеры.
- [x] Реализовать hit‑test: прямоугольник, линия/штрих с допуском толщины.
- [x] Добавить юнит‑тесты для математики и hit‑test.

## Этап 2 — JSON сериализация (v1)

- [x] Схема JSON с `schemaVersion = 1`.
- [x] Экспорт/импорт сцены и узлов (включая `ImageNode` и `TextNode`).
- [x] Валидация входного JSON и понятные ошибки.
- [x] Юнит‑тесты сериализации/десериализации.

## Этап 3 — Отрисовка

- [x] Реализовать `ScenePainter`: фон, сетка, слои, узлы.
- [x] Отрисовка узлов: image, text, stroke, line, rect.
- [x] Отрисовка выделения и рамки выделения.

## Этап 4 — Ввод и инструменты

- [ ] Обработка pointer down/move/up, double‑tap.
- [ ] Move режим: выбор, drag‑move, marquee‑selection.
- [ ] Draw режим: pen, highlighter, line (drag + two‑tap), eraser.
- [ ] Соблюдение границ действий и `ActionCommitted`.

## Этап 5 — Публичный API и интеграция

- [ ] `SceneController` как единый источник истины.
- [ ] События: `ActionCommitted`, `EditTextRequested`, уведомление об изменениях.
- [ ] `SceneView` (widget) + `CustomPaint` + `Listener`.
- [ ] `ImageResolver` контракт: `imageId -> ui.Image`.

## Этап 6 — Example приложение

- [ ] Переключение Move/Draw и инструментов.
- [ ] Добавление тестовых объектов.
- [ ] Команды rotate/flip/delete/clear.
- [ ] Палитры цветов, фон, сетка, камера по X.
- [ ] Визуальная метка старта для двухтаповой линии.

## Этап 7 — Тестирование и стабилизация

- [ ] Прогнать `flutter test`.
- [ ] (Опционально) золотые тесты рендера.
- [ ] Ручная проверка сценариев из `TZ.md`.

## Ручной чек‑лист (пример)

- [ ] Выделение одиночное/рамкой, перемещение, rotate/flip/delete/clear.
- [ ] Рисование pen/highlighter/line (drag и two‑tap).
- [ ] Ластик удаляет только аннотации.
- [ ] Камера по X влияет на рендер и hit‑test.
- [ ] Экспорт/импорт JSON сохраняет сцену.
